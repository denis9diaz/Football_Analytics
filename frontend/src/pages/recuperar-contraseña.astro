---
import Layout from '../layouts/Layout.astro';
import '../styles/global.css';
import 'animate.css';
---

<Layout>
  <div id="recovery-toast" class="hidden fixed top-6 left-1/2 transform -translate-x-1/2 bg-blue-600 text-white px-6 py-3 rounded shadow-lg z-50 transition-all duration-300"></div>

  <section class="max-w-5xl mx-auto px-4 py-16 text-center mt-8 animate__animated animate__fadeIn" style="animation-duration: 0.8s;">
    <div class="max-w-md mx-auto bg-gradient-to-br from-blue-50 to-white border border-blue-200 rounded-2xl shadow-md p-8">
      <h2 class="text-2xl font-bold text-blue-600 mb-8">Recuperar contraseña</h2>
      <form onsubmit="handleRecovery(event)" class="space-y-6 text-left">
        <div>
          <label for="email" class="block text-sm font-medium text-gray-700 mb-2">Correo electrónico</label>
          <input
            type="email"
            id="email"
            name="email"
            class="w-full px-4 py-2 border border-gray-300 rounded-md bg-white focus:ring-blue-600 focus:border-blue-600"
            required
          />
        </div>
        <button
          type="submit"
          class="w-full bg-blue-600 text-white px-6 py-2 rounded font-semibold hover:bg-blue-700 transition"
        >
          Enviar contraseña temporal
        </button>
      </form>
    </div>
  </section>

  <script is:inline>
    const API_URL = "http://localhost:8000";

    function showRecoveryToast(message, isError = false) {
      const el = document.getElementById("recovery-toast");
      el.textContent = message;
      el.classList.remove("hidden");
      el.classList.toggle("bg-blue-600", !isError);
      el.classList.toggle("bg-red-600", isError);
      setTimeout(() => el.classList.add("hidden"), 4000);
    }

    window.handleRecovery = async function (event) {
      event.preventDefault();
      const form = event.target;
      const email = form.email.value;

      try {
        const res = await fetch(`${API_URL}/api/auth/send_temp_password/`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ email }),
        });

        if (res.ok) {
          showRecoveryToast("Contraseña enviada a tu correo");
        } else {
          const data = await res.json();
          const msg = data.detail || "No se pudo enviar la contraseña";
          showRecoveryToast(msg, true);
        }
      } catch (err) {
        showRecoveryToast("Error de conexión con el servidor", true);
      }
    }
  </script>

  <link
    rel="stylesheet"
    href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"
  />
</Layout>
