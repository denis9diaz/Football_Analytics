---
import Layout from "../layouts/Layout.astro";
import "../styles/global.css";
---

<Layout>
  <section class="max-w-3xl mx-auto px-4 py-12 mt-10">
    <!-- Perfil -->
    <div class="bg-white border border-gray-200 rounded-xl shadow-sm p-6">
      <h2 class="text-lg font-semibold text-gray-800 mb-4">Perfil</h2>

      <!-- Username editable -->
      <div class="mb-4">
        <label for="username" class="text-sm text-gray-600 block mb-1"
          >Username</label
        >
        <div class="flex items-center gap-2">
          <input
            id="username"
            type="text"
            class="border border-gray-300 rounded-md px-3 py-2 text-sm w-[160px] focus:outline-none select-none pointer-events-none text-gray-800"
            readonly
          />
          <button
            id="edit-button"
            class="text-gray-500 hover:text-blue-600"
            title="Editar"
          >
            <i class="fas fa-pen"></i>
          </button>
          <button
            id="save-button"
            class="hidden text-sm text-white bg-blue-600 hover:bg-blue-700 px-3 py-1 rounded-md"
          >
            Guardar
          </button>
        </div>
      </div>

      <!-- Email no editable -->
      <div class="mb-4">
        <label class="text-sm text-gray-600 block mb-1">Email</label>
        <input
          type="email"
          class="border border-gray-200 bg-gray-100 rounded-md px-3 py-2 text-sm w-full select-none pointer-events-none text-gray-700 outline-none focus:outline-none"
          readonly
          value="denis9diaz@hotmail.com"
        />
      </div>

      <!-- Change Password Link -->
      <div class="mt-6">
        <a
          href="/cambiar-contraseña"
          class="text-sm text-blue-600 hover:underline"
        >
          Cambiar contraseña
        </a>
      </div>
    </div>
  </section>

  <script is:inline>
    const input = document.getElementById("username");
    const editBtn = document.getElementById("edit-button");
    const saveBtn = document.getElementById("save-button");

    const storedUsername = localStorage.getItem("username") || "denis9diaz";
    input.value = storedUsername;

    editBtn.addEventListener("click", () => {
      input.removeAttribute("readonly");
      input.classList.remove("select-none", "pointer-events-none");
      input.focus();
      saveBtn.classList.remove("hidden");
      editBtn.classList.add("hidden");
    });

    saveBtn.addEventListener("click", () => {
      const newUsername = input.value.trim();
      if (newUsername) {
        localStorage.setItem("username", newUsername);
        input.setAttribute("readonly", true);
        input.classList.add("select-none", "pointer-events-none");
        saveBtn.classList.add("hidden");
        editBtn.classList.remove("hidden");

        // Emitir evento personalizado
        const usernameUpdatedEvent = new CustomEvent("usernameUpdated", {
          detail: { username: newUsername },
        });
        window.dispatchEvent(usernameUpdatedEvent);

        // Actualizar también en el navbar si está cargado
        const navbarSpan = document.querySelector("#user-name");
        if (navbarSpan) {
          navbarSpan.textContent = newUsername;
        }
      }
    });
  </script>

  <link
    rel="stylesheet"
    href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"
  />
</Layout>
