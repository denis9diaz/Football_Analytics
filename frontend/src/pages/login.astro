---
import Layout from "../layouts/Layout.astro";
import "../styles/global.css";
import "animate.css";
---

<Layout>
  <!-- Contenedor del toast -->
  <div
    id="toast-message"
    class="hidden fixed top-6 left-1/2 transform -translate-x-1/2 bg-blue-600 text-white px-6 py-3 rounded shadow-lg z-50 transition-all duration-300"
  >
  </div>

  <section
    class="max-w-5xl mx-auto px-4 py-16 text-center mt-8 animate__animated animate__fadeIn"
    style="animation-duration: 0.8s;"
  >
    <div
      class="max-w-md mx-auto bg-gradient-to-br from-blue-50 to-white border border-blue-200 rounded-2xl shadow-md p-8"
    >
      <h2 class="text-2xl font-bold text-blue-600 mb-8">Iniciar sesión</h2>
      <form class="space-y-6 text-left" onsubmit="handleLoginSubmit(event)">
        <div>
          <label
            for="username_or_email"
            class="block text-sm font-medium text-gray-700 mb-2"
            >Correo electrónico o usuario</label
          >
          <input
            type="text"
            id="username_or_email"
            name="username_or_email"
            spellcheck="false"
            class="w-full px-4 py-2 border border-gray-300 rounded-md bg-white focus:ring-blue-600 focus:border-blue-600"
            required
          />
        </div>
        <div>
          <label
            for="password"
            class="block text-sm font-medium text-gray-700 mb-2"
            >Contraseña</label
          >
          <div class="relative">
            <input
              type="password"
              id="password"
              name="password"
              spellcheck="false"
              autocomplete="off"
              class="w-full px-4 py-2 border border-gray-300 rounded-md bg-white focus:ring-blue-600 focus:border-blue-600 pr-10"
              required
            />
            <button
              type="button"
              tabindex="-1"
              class="absolute inset-y-0 right-0 flex items-center px-3 text-gray-500 cursor-pointer"
              onclick="togglePasswordVisibility('password', this)"
            >
              <i class="fa-solid fa-eye-slash"></i>
            </button>
          </div>
        </div>
        <button
          type="submit"
          class="w-full bg-blue-600 text-white px-6 py-2 rounded font-semibold hover:bg-blue-700 transition cursor-pointer"
          >Iniciar sesión</button
        >
      </form>
      <p class="text-sm text-gray-600 mt-4">
        ¿No tienes cuenta?
        <a href="/registro" class="text-blue-600 hover:underline">Regístrate</a>
        |
        <a href="/recuperar-contraseña" class="text-blue-600 hover:underline"
          >¿Olvidaste tu contraseña?</a
        >
      </p>
    </div>
  </section>

  <!-- FontAwesome -->
  <link
    rel="stylesheet"
    href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"
    crossorigin="anonymous"
    referrerpolicy="no-referrer"
  />

  <!-- Script funcional -->
  <script is:inline>
    const API_URL = "http://localhost:8000";

    window.togglePasswordVisibility = function (inputId, button) {
      const input = document.getElementById(inputId);
      const icon = button.querySelector("i");

      if (input.type === "password") {
        input.type = "text";
        icon.classList.remove("fa-eye-slash");
        icon.classList.add("fa-eye");
      } else {
        input.type = "password";
        icon.classList.remove("fa-eye");
        icon.classList.add("fa-eye-slash");
      }
    };

    function showToast(message) {
      const toastEl = document.getElementById("toast-message");
      toastEl.textContent = message;
      toastEl.classList.remove("hidden");
      setTimeout(() => toastEl.classList.add("hidden"), 4000);
    }

    window.handleLoginSubmit = async function (event) {
      event.preventDefault();
      const form = event.target;
      const username_or_email = form.username_or_email.value;
      const password = form.password.value;

      try {
        const response = await fetch(`${API_URL}/api/auth/login/`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ username_or_email, password }),
        });

        const data = await response.json();

        if (!response.ok) {
          const errorMsg =
            data.detail ||
            (data.non_field_errors && data.non_field_errors[0]) ||
            "Error al iniciar sesión";
          showToast(errorMsg);
          return;
        }

        localStorage.setItem("access", data.access);
        localStorage.setItem("refresh", data.refresh);
        localStorage.setItem("username", data.username);

        window.location.href = "/analisis";
      } catch (error) {
        showToast("Error de conexión con el servidor");
      }
    };
  </script>
</Layout>
