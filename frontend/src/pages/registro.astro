---
import Layout from "../layouts/Layout.astro";
import "../styles/global.css";
import "animate.css";
---

<Layout>
  <section class="max-w-5xl mx-auto px-4 py-16 text-center mt-8 animate__animated animate__fadeIn" style="animation-duration: 0.8s;">
    <div class="max-w-md mx-auto bg-gradient-to-br from-blue-50 to-white border border-blue-200 rounded-2xl shadow-md p-8">
      <h2 class="text-2xl font-bold text-blue-600 mb-8">Crear cuenta</h2>
      <form class="space-y-6 text-left" onsubmit="handleSubmit(event)">
        <div>
          <label for="username" class="block text-sm font-medium text-gray-700 mb-2">Nombre de usuario</label>
          <input type="text" id="username" name="username" class="w-full px-4 py-2 border border-gray-300 rounded-md bg-white focus:ring-blue-600 focus:border-blue-600" required />
        </div>
        <div>
          <label for="email" class="block text-sm font-medium text-gray-700 mb-2">Correo electrónico</label>
          <input type="email" id="email" name="email" class="w-full px-4 py-2 border border-gray-300 rounded-md bg-white focus:ring-blue-600 focus:border-blue-600" required />
        </div>
        <div>
          <label for="password" class="block text-sm font-medium text-gray-700 mb-2">Contraseña</label>
          <div class="relative">
            <input type="password" id="password" name="password" class="w-full px-4 py-2 border border-gray-300 rounded-md bg-white focus:ring-blue-600 focus:border-blue-600 pr-10" required />
            <button type="button" class="absolute inset-y-0 right-0 flex items-center px-3 text-gray-500 cursor-pointer" onclick="togglePasswordVisibility('password', this)">
              <i class="fa-solid fa-eye-slash"></i>
            </button>
          </div>
        </div>
        <div>
          <label for="confirm-password" class="block text-sm font-medium text-gray-700 mb-2">Repetir contraseña</label>
          <div class="relative">
            <input type="password" id="confirm-password" name="confirm-password" class="w-full px-4 py-2 border border-gray-300 rounded-md bg-white focus:ring-blue-600 focus:border-blue-600 pr-10" required />
            <button type="button" class="absolute inset-y-0 right-0 flex items-center px-3 text-gray-500 cursor-pointer" onclick="togglePasswordVisibility('confirm-password', this)">
              <i class="fa-solid fa-eye-slash"></i>
            </button>
          </div>
        </div>
        <button type="submit" class="w-full bg-blue-600 text-white px-6 py-2 rounded font-semibold hover:bg-blue-700 transition cursor-pointer">
          Registrarse
        </button>
      </form>
      <p class="text-sm text-gray-600 mt-4">
        ¿Ya tienes cuenta?
        <a href="/login" class="text-blue-600 hover:underline">Iniciar sesión</a>
      </p>
    </div>
  </section>

  <!-- TOAST -->
  <div id="toast-container" class="fixed top-5 left-1/2 transform -translate-x-1/2 z-50 hidden">
    <div class="bg-blue-600 text-white px-6 py-3 rounded-lg shadow-lg animate__animated animate__fadeInDown">
      <span id="toast-message"></span>
    </div>
  </div>

  <!-- FontAwesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" crossorigin="anonymous" referrerpolicy="no-referrer" />

  <script is:inline>
    window.togglePasswordVisibility = function (inputId, button) {
      const input = document.getElementById(inputId);
      const icon = button.querySelector("i");
      if (input.type === "password") {
        input.type = "text";
        icon.classList.remove("fa-eye-slash");
        icon.classList.add("fa-eye");
      } else {
        input.type = "password";
        icon.classList.remove("fa-eye");
        icon.classList.add("fa-eye-slash");
      }
    };

    function showToast(message, redirect = false) {
      const container = document.getElementById("toast-container");
      const msg = document.getElementById("toast-message");
      msg.textContent = message;
      container.classList.remove("hidden");

      setTimeout(() => {
        container.classList.add("hidden");
        if (redirect) window.location.href = "/login";
      }, 3500);
    }

    window.handleSubmit = async function (event) {
      event.preventDefault();

      const form = event.target;
      const username = form.username.value;
      const email = form.email.value;
      const password = form.password.value;
      const password2 = form["confirm-password"].value;

      if (password !== password2) {
        showToast("Las contraseñas no coinciden");
        return;
      }

      try {
        const response = await fetch("http://localhost:8000/api/auth/register/", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ username, email, password, password2 }),
        });

        const data = await response.json();

        if (!response.ok) {
          const errorMsg =
            data.email ||
            data.username ||
            (data.password && Array.isArray(data.password) ? data.password.join(" ") : data.password) ||
            data.detail ||
            "Error al registrarse";
          showToast(errorMsg.includes("This password is too") ?
            "Formato de contraseña no válido (mínimo 8 caracteres, sin solo números, ni comunes)" :
            errorMsg
          );
          return;
        }

        showToast("Registro exitoso. Revisa tu correo para activar tu cuenta.", true);
      } catch (err) {
        showToast("Error de conexión con el servidor");
      }
    };
  </script>
</Layout>
